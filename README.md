# go-cacheprogw

_cacheprogw_ stands for **CacheProg W**riter.

cacheprogw is a library following the same way how go/cmd talks to external cache programs using the [CacheProg protocol](https://github.com/golang/go/issues/59719). Useful if you want to act like go/cmd. Codes are ported from [Go 1.24 source code](https://github.com/golang/go/blob/go1.24.3/src/cmd/go/internal/cache/prog.go) with some modifications for better usability.

Note: **This is a library for calling an external cache program (as a client)**, instead of implementing the cache program itself (as a server). To implement a cache program server, see:

- https://github.com/hirasawayuki/go-cache-prog
- https://github.com/bigwhite/go-cache-prog
- https://github.com/gocica-go/gocica

## Installation

```bash
go get github.com/breezewish/go-cacheprogw
```

## Example

```go
package main

import (
    "bytes"
    "fmt"

    "github.com/breezewish/go-cacheprogw"
)

func main() {
    proc, err := cacheprogw.Start("<your-cacheprog-binary>")
    if err != nil {
        panic(err)
    }
    defer proc.Close()

    // An ActionID is a cache action key, the hash of a complete description of a
    // repeatable computation (command line, environment variables,
    // input file contents, executable contents).
    //
    // Currently ActionID is fixed to be 32 bytes in order to follow
    // the same length that go/cmd produces.
    var actionID cacheprogw.ActionID
    copy(actionID[:], []byte("my-cache-key-1234567890abcdef"))

    // Note: According to how go/cmd works, the ActionID should be better generated by
    // using the hash of your "action" as below:
    //
    //   h := cacheprogw.NewHash()
    //   h.Write([]byte("open <file>"))
    //   actionID := h.Sum()

    // Put data into cache. A cacheprog is supposed to make sure
    // that data is available at DiskPath locally.
    data := bytes.NewReader([]byte("The result of open <file>"))
    putResult, err := proc.Put(actionID, data)
    if err != nil {
        panic(err)
    }
    fmt.Printf("Stored %d bytes at %s\n", putResult.Size, putResult.DiskPath)

    // Get data from cache. A cacheprog is supposed to make sure
    // that data is available at DiskPath locally.
    getResult, err := proc.Get(actionID)
    if err != nil {
        panic(err)
    }
    fmt.Printf("Retrieved %d bytes from %s\n", getResult.Size, getResult.DiskPath)
}
```

## License

Copyright 2009 The Go Authors. See [LICENSE](./LICENSE) for details.
